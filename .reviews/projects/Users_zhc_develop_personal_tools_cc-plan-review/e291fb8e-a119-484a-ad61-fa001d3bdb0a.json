{
  "id": "e291fb8e-a119-484a-ad61-fa001d3bdb0a",
  "createdAt": 1764083630138,
  "status": "pending",
  "planContent": "# 计划：MCP 服务器双传输模式支持\n\n## 目标\n让 MCP 服务器同时支持 stdio 和 HTTP 两种传输模式，通过命令行参数切换。\n\n## 架构设计\n\n```\n启动参数: --transport=stdio | http (默认 stdio)\n\nstdio 模式:\n  MCP 通信 → stdin/stdout (StdioServerTransport)\n  Web UI  → Express HTTP 服务 (始终运行)\n\nhttp 模式:\n  MCP 通信 → POST /mcp (StreamableHTTPServerTransport)\n  Web UI  → Express HTTP 服务 (同一个服务器)\n```\n\n## 实现步骤\n\n### 1. 修改 `src/mcp-server.ts`\n\n添加 stdio 传输支持：\n\n```typescript\nimport { StdioServerTransport } from '@modelcontextprotocol/sdk/server/stdio.js';\n\nexport class McpService {\n  private stdioTransport?: StdioServerTransport;\n\n  // 新增：启动 stdio 模式\n  async startStdioTransport(): Promise<void> {\n    this.stdioTransport = new StdioServerTransport();\n    await this.server.connect(this.stdioTransport);\n    logger.info('MCP server connected via stdio transport');\n  }\n\n  // 现有的 handleRequest 保持不变，用于 HTTP 模式\n}\n```\n\n### 2. 修改 `src/http-server.ts`\n\n根据传输模式决定是否注册 `/mcp` 端点：\n\n```typescript\nexport class HttpServer {\n  constructor(\n    reviewManager: ReviewManager,\n    mcpService: McpService,\n    options?: { enableMcpEndpoint?: boolean }\n  ) {\n    // 仅在 HTTP 模式下注册 /mcp 端点\n    if (options?.enableMcpEndpoint !== false) {\n      this.app.post('/mcp', ...);\n    }\n  }\n}\n```\n\n### 3. 修改 `src/index.ts`\n\n解析命令行参数，选择传输模式：\n\n```typescript\nasync function main() {\n  // 解析参数\n  const args = process.argv.slice(2);\n  const transportMode = args.includes('--transport=http') ? 'http' : 'stdio';\n\n  const reviewManager = new ReviewManager();\n  const mcpService = new McpService(reviewManager, () => baseUrl);\n\n  // 始终启动 HTTP 服务（Web UI 需要）\n  const httpServer = new HttpServer(reviewManager, mcpService, {\n    enableMcpEndpoint: transportMode === 'http'\n  });\n  const port = await httpServer.start();\n  baseUrl = `http://localhost:${port}`;\n\n  // 根据模式启动 MCP 传输\n  if (transportMode === 'stdio') {\n    await mcpService.startStdioTransport();\n    logger.info('Running in stdio mode, Web UI at ' + baseUrl);\n  } else {\n    logger.info('Running in HTTP mode, MCP endpoint at ' + baseUrl + '/mcp');\n  }\n}\n```\n\n### 4. 更新 `.mcp.json`\n\n```json\n{\n  \"mcpServers\": {\n    \"plan-reviewer\": {\n      \"command\": \"node\",\n      \"args\": [\"${CLAUDE_PLUGIN_ROOT}dist/index.js\", \"--transport=stdio\"]\n    }\n  }\n}\n```\n\n## 需要修改的文件\n\n| 文件 | 修改内容 |\n|------|---------|\n| `src/mcp-server.ts` | 添加 `startStdioTransport()` 方法 |\n| `src/http-server.ts` | 添加 `enableMcpEndpoint` 选项 |\n| `src/index.ts` | 解析 `--transport` 参数，条件启动 |\n| `.mcp.json` | 添加 `--transport=stdio` 参数 |\n\n## 使用方式\n\n**作为 Claude Code 插件 (stdio)**\n```bash\n# 自动由 Claude Code 启动，配置在 .mcp.json\n```\n\n**作为独立服务 (HTTP)**\n```bash\nnode dist/index.js --transport=http\n# 或\nclaude mcp add --transport http plan-reviewer http://localhost:3030/mcp\n```\n\n## 日志注意事项\n\n- 日志已正确输出到 stderr（`logger.ts`）✅\n- stdio 模式下不会干扰 MCP 协议\n- 无需额外修改日志系统\n",
  "comments": [],
  "documentVersions": [
    {
      "versionHash": "8678d0499a027337093eb93d261737f6068769e10291d984418eb6417a297da1",
      "content": "# 计划：MCP 服务器双传输模式支持\n\n## 目标\n让 MCP 服务器同时支持 stdio 和 HTTP 两种传输模式，通过命令行参数切换。\n\n## 架构设计\n\n```\n启动参数: --transport=stdio | http (默认 stdio)\n\nstdio 模式:\n  MCP 通信 → stdin/stdout (StdioServerTransport)\n  Web UI  → Express HTTP 服务 (始终运行)\n\nhttp 模式:\n  MCP 通信 → POST /mcp (StreamableHTTPServerTransport)\n  Web UI  → Express HTTP 服务 (同一个服务器)\n```\n\n## 实现步骤\n\n### 1. 修改 `src/mcp-server.ts`\n\n添加 stdio 传输支持：\n\n```typescript\nimport { StdioServerTransport } from '@modelcontextprotocol/sdk/server/stdio.js';\n\nexport class McpService {\n  private stdioTransport?: StdioServerTransport;\n\n  // 新增：启动 stdio 模式\n  async startStdioTransport(): Promise<void> {\n    this.stdioTransport = new StdioServerTransport();\n    await this.server.connect(this.stdioTransport);\n    logger.info('MCP server connected via stdio transport');\n  }\n\n  // 现有的 handleRequest 保持不变，用于 HTTP 模式\n}\n```\n\n### 2. 修改 `src/http-server.ts`\n\n根据传输模式决定是否注册 `/mcp` 端点：\n\n```typescript\nexport class HttpServer {\n  constructor(\n    reviewManager: ReviewManager,\n    mcpService: McpService,\n    options?: { enableMcpEndpoint?: boolean }\n  ) {\n    // 仅在 HTTP 模式下注册 /mcp 端点\n    if (options?.enableMcpEndpoint !== false) {\n      this.app.post('/mcp', ...);\n    }\n  }\n}\n```\n\n### 3. 修改 `src/index.ts`\n\n解析命令行参数，选择传输模式：\n\n```typescript\nasync function main() {\n  // 解析参数\n  const args = process.argv.slice(2);\n  const transportMode = args.includes('--transport=http') ? 'http' : 'stdio';\n\n  const reviewManager = new ReviewManager();\n  const mcpService = new McpService(reviewManager, () => baseUrl);\n\n  // 始终启动 HTTP 服务（Web UI 需要）\n  const httpServer = new HttpServer(reviewManager, mcpService, {\n    enableMcpEndpoint: transportMode === 'http'\n  });\n  const port = await httpServer.start();\n  baseUrl = `http://localhost:${port}`;\n\n  // 根据模式启动 MCP 传输\n  if (transportMode === 'stdio') {\n    await mcpService.startStdioTransport();\n    logger.info('Running in stdio mode, Web UI at ' + baseUrl);\n  } else {\n    logger.info('Running in HTTP mode, MCP endpoint at ' + baseUrl + '/mcp');\n  }\n}\n```\n\n### 4. 更新 `.mcp.json`\n\n```json\n{\n  \"mcpServers\": {\n    \"plan-reviewer\": {\n      \"command\": \"node\",\n      \"args\": [\"${CLAUDE_PLUGIN_ROOT}dist/index.js\", \"--transport=stdio\"]\n    }\n  }\n}\n```\n\n## 需要修改的文件\n\n| 文件 | 修改内容 |\n|------|---------|\n| `src/mcp-server.ts` | 添加 `startStdioTransport()` 方法 |\n| `src/http-server.ts` | 添加 `enableMcpEndpoint` 选项 |\n| `src/index.ts` | 解析 `--transport` 参数，条件启动 |\n| `.mcp.json` | 添加 `--transport=stdio` 参数 |\n\n## 使用方式\n\n**作为 Claude Code 插件 (stdio)**\n```bash\n# 自动由 Claude Code 启动，配置在 .mcp.json\n```\n\n**作为独立服务 (HTTP)**\n```bash\nnode dist/index.js --transport=http\n# 或\nclaude mcp add --transport http plan-reviewer http://localhost:3030/mcp\n```\n\n## 日志注意事项\n\n- 日志已正确输出到 stderr（`logger.ts`）✅\n- stdio 模式下不会干扰 MCP 协议\n- 无需额外修改日志系统\n",
      "createdAt": 1764083630138
    }
  ],
  "currentVersion": "8678d0499a027337093eb93d261737f6068769e10291d984418eb6417a297da1",
  "projectPath": "/Users/zhc/develop/personal/tools/cc-plan-review"
}