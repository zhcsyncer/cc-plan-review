{
  "id": "test-review-003",
  "createdAt": 1732442400000,
  "status": "pending",
  "planContent": "# API 重构计划（第二版）\n\n## 更新说明\n\n基于第一轮审查的反馈，我们更新了 API 设计方案。\n\n## 目标\n\n将现有的 REST API 重构为 **GraphQL API**，以提升灵活性和性能。\n\n## 架构设计\n\n### Schema 定义\n\n```graphql\ntype User {\n  id: ID!\n  name: String!\n  email: String!\n  posts: [Post!]!\n  createdAt: DateTime!\n}\n\ntype Post {\n  id: ID!\n  title: String!\n  content: String!\n  author: User!\n  comments: [Comment!]!\n  publishedAt: DateTime\n}\n\ntype Comment {\n  id: ID!\n  text: String!\n  author: User!\n  post: Post!\n}\n\ntype Query {\n  user(id: ID!): User\n  users(limit: Int, offset: Int): [User!]!\n  post(id: ID!): Post\n  posts(authorId: ID, limit: Int): [Post!]!\n}\n\ntype Mutation {\n  createUser(name: String!, email: String!): User!\n  createPost(title: String!, content: String!, authorId: ID!): Post!\n  createComment(text: String!, postId: ID!, authorId: ID!): Comment!\n}\n```\n\n### Resolver 实现\n\n```typescript\nimport { GraphQLResolveInfo } from 'graphql';\n\ninterface Context {\n  db: DatabaseConnection;\n  user: User | null;\n}\n\nconst resolvers = {\n  Query: {\n    user: async (\n      parent: any,\n      args: { id: string },\n      context: Context,\n      info: GraphQLResolveInfo\n    ) => {\n      return context.db.users.findById(args.id);\n    },\n    \n    posts: async (\n      parent: any,\n      args: { authorId?: string; limit?: number },\n      context: Context\n    ) => {\n      const query = context.db.posts.query();\n      \n      if (args.authorId) {\n        query.where('author_id', args.authorId);\n      }\n      \n      if (args.limit) {\n        query.limit(args.limit);\n      }\n      \n      return query.execute();\n    }\n  },\n  \n  User: {\n    posts: async (parent: User, args: any, context: Context) => {\n      return context.db.posts\n        .query()\n        .where('author_id', parent.id)\n        .execute();\n    }\n  }\n};\n```\n\n## 迁移策略\n\n```mermaid\ngraph LR\n    A[现有 REST API] --> B[添加 GraphQL 层]\n    B --> C[逐步迁移客户端]\n    C --> D[废弃 REST 端点]\n    D --> E[完全切换到 GraphQL]\n```\n\n## 性能优化\n\n### DataLoader 批处理\n\n```javascript\nconst DataLoader = require('dataloader');\n\nconst userLoader = new DataLoader(async (userIds) => {\n  const users = await db.users.findByIds(userIds);\n  return userIds.map(id => users.find(u => u.id === id));\n});\n\n// 在 resolver 中使用\nconst user = await context.loaders.user.load(userId);\n```\n\n## 测试计划\n\n1. **单元测试** - 测试每个 resolver\n2. **集成测试** - 测试完整的 GraphQL 查询\n3. **性能测试** - 对比 REST 和 GraphQL 的性能\n4. **负载测试** - 验证系统承受能力\n\n## 时间线\n\n- **Week 1-2:** Schema 设计和审查\n- **Week 3-4:** Resolver 实现\n- **Week 5-6:** 客户端迁移\n- **Week 7:** 性能优化和测试\n- **Week 8:** 生产环境部署\n\n## 风险与挑战\n\n### 技术风险\n\n- GraphQL 查询复杂度控制\n- N+1 查询问题（通过 DataLoader 解决）\n- 缓存策略调整\n\n### 团队风险\n\n- 需要培训团队掌握 GraphQL\n- 可能需要额外的开发时间\n\n## 结论\n\nGraphQL 重构将为我们的 API 带来更好的灵活性和性能。",
  "comments": [
    {
      "id": "comment-008",
      "createdAt": 1732442500000,
      "quote": "将现有的 REST API 重构为 **GraphQL API**",
      "comment": "为什么选择 GraphQL？建议补充详细的对比分析（REST vs GraphQL）以及选型依据。",
      "position": {
        "startOffset": 85,
        "endOffset": 120
      },
      "documentVersion": "version-3-hash",
      "positionStatus": "valid"
    },
    {
      "id": "comment-009",
      "createdAt": 1732442600000,
      "quote": "Week 1-2:",
      "comment": "时间安排看起来比较紧张，建议为每个阶段预留 buffer 时间。",
      "position": {
        "startOffset": 1823,
        "endOffset": 1832
      },
      "documentVersion": "version-2-hash",
      "originalPosition": {
        "startOffset": 1750,
        "endOffset": 1759
      },
      "positionStatus": "adjusted"
    },
    {
      "id": "comment-010",
      "createdAt": 1732442700000,
      "quote": "DataLoader 批处理",
      "comment": "非常好的优化方案！建议在文档中添加性能对比数据。",
      "position": {
        "startOffset": 1456,
        "endOffset": 1473
      },
      "documentVersion": "version-3-hash",
      "positionStatus": "valid"
    },
    {
      "id": "comment-011",
      "createdAt": 1732442800000,
      "quote": "需要培训团队掌握 GraphQL",
      "comment": "建议列出具体的培训计划和资源（例如在线课程、内部分享等）。",
      "position": {
        "startOffset": 2015,
        "endOffset": 2032
      },
      "documentVersion": "version-3-hash",
      "positionStatus": "valid"
    },
    {
      "id": "comment-012",
      "createdAt": 1732442900000,
      "quote": "缓存策略调整",
      "comment": "这是一个重要的点！REST 和 GraphQL 的缓存机制有很大不同，需要详细规划。",
      "position": {
        "startOffset": 1947,
        "endOffset": 1954
      },
      "documentVersion": "version-3-hash",
      "positionStatus": "valid"
    }
  ],
  "documentVersions": [
    {
      "versionHash": "version-1-hash",
      "content": "# API 重构计划\n\n## 目标\n\n将现有的 REST API 重构为 GraphQL API。\n\n## 初步设计\n\n（第一版内容，较简略）",
      "createdAt": 1732440000000
    },
    {
      "versionHash": "version-2-hash",
      "content": "# API 重构计划（修订版）\n\n## 更新说明\n\n基于反馈更新了设计。\n\n## 目标\n\n将现有的 REST API 重构为 GraphQL API，提升灵活性。\n\n## 时间线\n\n- Week 1-2: 设计\n- Week 3-4: 实现\n- Week 5: 测试\n\n（第二版内容，添加了时间线）",
      "createdAt": 1732441000000,
      "changes": [
        {
          "type": "insert",
          "startOffset": 0,
          "endOffset": 50,
          "newText": "# API 重构计划（修订版）\n\n## 更新说明\n\n基于反馈更新了设计。\n\n"
        }
      ]
    },
    {
      "versionHash": "version-3-hash",
      "content": "# API 重构计划（第二版）\n\n## 更新说明\n\n基于第一轮审查的反馈，我们更新了 API 设计方案。\n\n## 目标\n\n将现有的 REST API 重构为 **GraphQL API**，以提升灵活性和性能。\n\n## 架构设计\n\n### Schema 定义\n\n```graphql\ntype User {\n  id: ID!\n  name: String!\n  email: String!\n  posts: [Post!]!\n  createdAt: DateTime!\n}\n\ntype Post {\n  id: ID!\n  title: String!\n  content: String!\n  author: User!\n  comments: [Comment!]!\n  publishedAt: DateTime\n}\n\ntype Comment {\n  id: ID!\n  text: String!\n  author: User!\n  post: Post!\n}\n\ntype Query {\n  user(id: ID!): User\n  users(limit: Int, offset: Int): [User!]!\n  post(id: ID!): Post\n  posts(authorId: ID, limit: Int): [Post!]!\n}\n\ntype Mutation {\n  createUser(name: String!, email: String!): User!\n  createPost(title: String!, content: String!, authorId: ID!): Post!\n  createComment(text: String!, postId: ID!, authorId: ID!): Comment!\n}\n```\n\n### Resolver 实现\n\n```typescript\nimport { GraphQLResolveInfo } from 'graphql';\n\ninterface Context {\n  db: DatabaseConnection;\n  user: User | null;\n}\n\nconst resolvers = {\n  Query: {\n    user: async (\n      parent: any,\n      args: { id: string },\n      context: Context,\n      info: GraphQLResolveInfo\n    ) => {\n      return context.db.users.findById(args.id);\n    },\n    \n    posts: async (\n      parent: any,\n      args: { authorId?: string; limit?: number },\n      context: Context\n    ) => {\n      const query = context.db.posts.query();\n      \n      if (args.authorId) {\n        query.where('author_id', args.authorId);\n      }\n      \n      if (args.limit) {\n        query.limit(args.limit);\n      }\n      \n      return query.execute();\n    }\n  },\n  \n  User: {\n    posts: async (parent: User, args: any, context: Context) => {\n      return context.db.posts\n        .query()\n        .where('author_id', parent.id)\n        .execute();\n    }\n  }\n};\n```\n\n## 迁移策略\n\n```mermaid\ngraph LR\n    A[现有 REST API] --> B[添加 GraphQL 层]\n    B --> C[逐步迁移客户端]\n    C --> D[废弃 REST 端点]\n    D --> E[完全切换到 GraphQL]\n```\n\n## 性能优化\n\n### DataLoader 批处理\n\n```javascript\nconst DataLoader = require('dataloader');\n\nconst userLoader = new DataLoader(async (userIds) => {\n  const users = await db.users.findByIds(userIds);\n  return userIds.map(id => users.find(u => u.id === id));\n});\n\n// 在 resolver 中使用\nconst user = await context.loaders.user.load(userId);\n```\n\n## 测试计划\n\n1. **单元测试** - 测试每个 resolver\n2. **集成测试** - 测试完整的 GraphQL 查询\n3. **性能测试** - 对比 REST 和 GraphQL 的性能\n4. **负载测试** - 验证系统承受能力\n\n## 时间线\n\n- **Week 1-2:** Schema 设计和审查\n- **Week 3-4:** Resolver 实现\n- **Week 5-6:** 客户端迁移\n- **Week 7:** 性能优化和测试\n- **Week 8:** 生产环境部署\n\n## 风险与挑战\n\n### 技术风险\n\n- GraphQL 查询复杂度控制\n- N+1 查询问题（通过 DataLoader 解决）\n- 缓存策略调整\n\n### 团队风险\n\n- 需要培训团队掌握 GraphQL\n- 可能需要额外的开发时间\n\n## 结论\n\nGraphQL 重构将为我们的 API 带来更好的灵活性和性能。",
      "createdAt": 1732442400000,
      "changes": [
        {
          "type": "modify",
          "startOffset": 0,
          "endOffset": 200,
          "oldText": "# API 重构计划（修订版）",
          "newText": "# API 重构计划（第二版）\n\n## 更新说明\n\n基于第一轮审查的反馈，我们更新了 API 设计方案。"
        },
        {
          "type": "insert",
          "startOffset": 200,
          "endOffset": 2100,
          "newText": "\n\n## 架构设计\n\n### Schema 定义\n\n```graphql\n...(完整的 GraphQL schema)...\n```"
        }
      ]
    }
  ],
  "currentVersion": "version-3-hash"
}
